<!DOCTYPE html>
<html>
  <head>
    <title>åŸºäº Flask çš„ Web API å¼€å‘æŒ‡å— v2.0 - PyCon China 2019 æˆéƒ½</title>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="./css/style.css">

    <script>
        var nan = function() {
            document.getElementById("blink").innerHTML="å—";
        } 
        var bei = function() {
            document.getElementById("blink").innerHTML="åŒ—";
            setTimeout(nan, 150)
        }   
        setInterval(bei, 2000);
    </script>
  </head>
  <body>

    <textarea id="source">

class: center, middle, title

<h1>åŸºäº Flask çš„ Web API å¼€å‘æŒ‡<span id="blink">å—</span> <div class="corner-ribbon top-right sticky orange">v2.0</div></h1>

æè¾‰ï¼ˆGrey Liï¼‰ ğŸ PyCon China 2019 æˆéƒ½

---

## æè¾‰ / Grey Li

<img src="./images/four.jpg" width="200px">

- é‡ç”Ÿç¨‹åºå‘˜
- [Flask](https://github.com/pallets/flask) ç»´æŠ¤è€…ä¹‹ä¸€
- ã€Š[Flask Web å¼€å‘å®æˆ˜](http://helloflask.com/book/)ã€‹ä½œè€…
- [HelloFlask](http://helloflask.com) ç®¡ç†å‘˜
- ä¸ªäººç½‘ç«™ [greyli.com](http://greyli.com)

---
class: center, middle

# å¬ä¼—è°ƒæŸ¥æ—¶é—´ ğŸ“ƒ

---

class: center, middle, inverse

## å››åˆ†é’Ÿå…¥é—¨ Flask å’Œ Web API å¼€å‘

---

## ä¸€åˆ†é’Ÿè®¤è¯† Flask

.footnote[https://palletsprojects.com/p/flask/]

--

- çŸ­å®šä¹‰ï¼šä¸€ä¸ª Python Web å¾®æ¡†æ¶

--

- é•¿å®šä¹‰ï¼šä¸€ä¸ªä¸»è¦åŸºäº Werkzeug å’Œ Jinja çš„è½»é‡ WSGI Web ç¨‹åºæ¡†æ¶

--

- æ— æœ¯è¯­ï¼šä¸€ä¸ªå¸®åŠ©ä½ æ›´æ–¹ä¾¿å¼€å‘ Web ç¨‹åº/åŠ¨æ€ç½‘ç«™çš„å·¥å…·ï¼Œåªå†…ç½®äº†ä¸€äº›åŸºç¡€åŠŸèƒ½ï¼Œå…¶ä»–çš„åŠŸèƒ½éƒ½è¦é€šè¿‡æ‰©å±•æ¥å®ç°

--

- åˆ—è¡¨ï¼š
    - Web å¾®æ¡†æ¶ï¼ˆWeb development, one drop at a timeï¼‰
    - å¾®æ ¸å¿ƒï¼ˆWerkzeug + Jinja2ï¼‰+æ˜“äºæ‰©å±•ï¼ˆç¬¬ä¸‰æ–¹æ‰©å±•ï¼‰
    - è‡ªç”±çµæ´»ï¼Œæ›´ Pythonic

--

- å›¾ï¼š 

.center[<img src="./images/flask.jpg" height="80px">]

---

## ä¸€åˆ†é’Ÿå…¥é—¨ Flask å¼€å‘

install
```bash
$ pip install flask
```

--

code
```python
# app.py
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return 'Hello, <a href="https://cn.pycon.org">PyCon China</a>!'
```

--

run
```bash
$ flask run
 ...
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
```

---

<img src="./images/app.png" width="700px">

---

## ä¸€åˆ†é’Ÿè®¤è¯† Web API

--

- çŸ­å®šä¹‰ï¼šJSON/XML over HTTP

--

- é•¿å®šä¹‰ï¼šå¯ä»¥ä½¿ç”¨ HTTP åè®®è¿›è¡Œè®¿é—®ï¼Œè¿”å› XML æˆ– JSON æ ¼å¼æ•°æ®çš„ API

--

- æ— æœ¯è¯­ï¼šç»™æœºå™¨/ç¨‹åºä½¿ç”¨ï¼Œé€šè¿‡ç½‘ç»œè®¿é—®ï¼Œè¿”å› JSON æˆ– XML æ ¼å¼çº¯æ•°æ®çš„æ¥å£ã€‚

--

- åˆ—è¡¨ï¼š
    - å¯ä»¥ä½¿ç”¨ HTTP è®¿é—®çš„ URL æ•°æ®é›†åˆ
    - è¿”å› JSON æˆ– XML æ ¼å¼çš„çº¯æ•°æ®
    - ä½¿ç”¨ URL æè¿°æ•°æ®
    - ä½¿ç”¨ä¸åŒçš„ HTTP æ–¹æ³•è¡¨ç¤ºä¸åŒçš„æ“ä½œ

--

- å›¾ï¼š<img src="./images/api-fake.png">

---

<img src="./images/vs.png" height="580px">

---

## ä¸€åˆ†é’Ÿå…¥é—¨ Web API å¼€å‘

code
```python
# app.py
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return {
        'message': 'Hello, PyCon China!',
        'url': 'https://cn.pycon.org'
    }
```

run
```bash
$ flask run
 ...
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
```

---

## ä¸€åˆ†é’Ÿå…¥é—¨ Web API å¼€å‘

code
```python
# app.py
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
*   return {
*       'message': 'Hello, PyCon China!',
*       'url': 'https://cn.pycon.org'
*   }
```

run
```bash
$ flask run
 ...
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
```

---

## ä¸€åˆ†é’Ÿå…¥é—¨ Web API å¼€å‘

install [HTTPie](https://httpie.org/)
```bash
$ pip install httpie
```

test
```bash
$ http get :5000
HTTP/1.0 200 OK
Content-Length: 54
Content-Type: application/json
Date: Tue, 17 Sep 2019 01:10:24 GMT
Server: Werkzeug/0.15.6 Python/3.6.8

{
    "message": "Hello, PyCon China!",
    "url": "https://cn.pycon.org"
}
```

---

## ä¸€åˆ†é’Ÿå…¥é—¨ Web API å¼€å‘

install [HTTPie](https://httpie.org/)
```bash
$ pip install httpie
```

test
```bash
$ http get :5000
HTTP/1.0 200 OK
Content-Length: 54
*Content-Type: application/json
Date: Tue, 17 Sep 2019 01:10:24 GMT
Server: Werkzeug/0.15.6 Python/3.6.8

*{
*   "message": "Hello, PyCon China!",
*   "url": "https://cn.pycon.org"
*}
```

---

## å‚åŠ  PyCon China çš„æ”¶è· +1

<div class="framed">

<h3 class="blur">ææ˜æ˜ åç«¯å·¥ç¨‹å¸ˆ</h3>

<h4 class="blur">ç¼–ç¨‹æŠ€èƒ½</h4>

<ul class="blur">
    <li>- ç²¾é€š Pythonã€PHPã€Java ç­‰è¯­è¨€</li>
    <li>- å†™è¿‡æ“ä½œç³»ç»Ÿå’Œç¼–è¯‘å™¨</li>
    <li>- æœ‰äº¿ä¸‡çº§é«˜å¹¶å‘é¡¹ç›®å¼€å‘ç»éªŒ</li>
    <li>- ä¸ç”¨é¼ æ ‡ï¼Œä¸ç”¨ IDEï¼Œä¸ç”¨ Windows</li>
</ul>
<p>
<span style="background: #bef5cb; padding: 10px"> +</span><span style="background: #cdffd8; padding: 10px 20px">- äº†è§£ Flask æ¡†æ¶å’Œ Web API</span>
</p>
<p>

<span style="background: #bef5cb; padding: 10px"> +</span><span style="background: #cdffd8; padding: 10px 20px">- èƒ½å¤Ÿä½¿ç”¨ Flask è¿›è¡Œ Web API å¼€å‘</span>

</p>
</div>

---
class: middle, center, inverse

# Web API æœ¯è¯­æ¢³ç†

---

class: middle

### Flask ä½¿ç”¨ cookie è€Œä¸æ˜¯ session å­˜å‚¨ session ä¿¡æ¯ã€‚åœ¨å¤„ç† cookie çš„æ—¶å€™ï¼ŒFlask ä¼šæŠŠå­˜å‚¨åˆ° session çš„ session ä¿¡æ¯åŠ å¯†åæ”¾åˆ° session cookie é‡Œã€‚ğŸ¤”

---

## session å››é‡å¥

1. ç”¨æˆ·ä¼šè¯ï¼ˆå¸¸è§„è¯­å¢ƒï¼‰
2. åœ¨æœåŠ¡å™¨ç«¯å­˜å‚¨ç”¨æˆ·ä¼šè¯çš„è®¤è¯å®ç°æ–¹æ³•ï¼ˆç”¨æˆ·è®¤è¯è¯­å¢ƒï¼‰
3. Flask æä¾›çš„å…¨å±€å˜é‡çš„åå­—ï¼ˆFlask è¯­å¢ƒï¼‰
4. ä¸€å— Cookie çš„é”®ï¼ˆFlask å®ç°ç”¨æˆ·è®¤è¯è¯­å¢ƒï¼‰

--

<hr>

Flask ä½¿ç”¨ cookie è€Œä¸æ˜¯ **session**ï¼ˆ2ï¼‰ å­˜å‚¨ **session**ï¼ˆ1ï¼‰ ä¿¡æ¯ã€‚åœ¨å¤„ç† cookie çš„æ—¶å€™ï¼ŒFlask ä¼šæŠŠå­˜å‚¨åˆ° **session**ï¼ˆ3ï¼‰ çš„ **session**ï¼ˆ1ï¼‰ ä¿¡æ¯åŠ å¯†åæ”¾åˆ° **session**ï¼ˆ4ï¼‰ cookie é‡Œã€‚

---

## æœ¯è¯­æ¢³ç†çš„æ–¹å¼

- å°½é‡ä½¿ç”¨è‹±æ–‡å½¢å¼
- å°½é‡ä½¿ç”¨æ­£ç¡®çš„æœ¯è¯­
- äº†è§£è¿™ä¸ªæœ¯è¯­çš„è‹±æ–‡å½¢å¼ã€å«ä¹‰å’Œæ¥æº
- äº†è§£æŸä¸€ä¸ªæœ¯è¯­åœ¨ä¸åŒè¯­å¢ƒä¸‹çš„ä¸åŒå«ä¹‰
- äº†è§£æŸä¸ªæœ¯è¯­ç›¸å…³çš„æœ¯è¯­ï¼Œäº†è§£è¿™äº›æœ¯è¯­ä¹‹é—´çš„å…³è”å’ŒåŒºåˆ«

---

## ä½¿ç”¨ HTTP åè®®é€šè¿‡ç½‘ç»œè°ƒç”¨çš„ API

--

- API / API æ¥å£

.footnote[
- https://en.wikipedia.org/wiki/Application_programming_interface
- https://en.wikipedia.org/wiki/Microservices
- https://en.wikipedia.org/wiki/Representational_state_transfer
- https://en.wikipedia.org/wiki/Web_service
- https://en.wikipedia.org/wiki/Web_API

]

--

- å¾®æœåŠ¡ï¼ˆMicroservicesï¼‰

--

- REST API / RESTful API

--

- Web æœåŠ¡ï¼ˆWeb Serviceï¼‰

--

- Web API ğŸˆ

---

## èµ„æºã€ç«¯ç‚¹å’Œé¦–éƒ¨

--

- èµ„æºï¼ˆResourcesï¼‰
- = æ•°æ®ï¼ˆDataï¼‰

--

- ç«¯ç‚¹ï¼ˆEndpointï¼‰
    - = URIï¼ˆUniform Resource **Identifier**ï¼‰ï¼šURL å’Œ URN çš„çˆ¶é›† ğŸˆ
    - = URLï¼ˆUniform Resource **Locator**ï¼‰ï¼šURI çš„æœ€å¸¸è§å½¢å¼ ğŸˆ
    - URNï¼ˆUniform Resource **Name**ï¼‰ï¼šURI çš„ä¸å¸¸è§å½¢å¼
    - ç½‘å€ï¼ˆWebsite addressï¼‰ï¼šhttp:// helloflask.com
    - è¶…é“¾æ¥/é“¾æ¥ï¼ˆHyperlink/Linkï¼‰ï¼š[HelloFlask](http://helloflask.com)

--

- HTTP é¦–éƒ¨ï¼ˆHeaderï¼‰
    - = é¦–éƒ¨
    - = å¤´éƒ¨
    - é¦–éƒ¨å­—æ®µï¼šé¦–éƒ¨ä¸­åŒ…å«çš„æŸäº›ä¿¡æ¯

---

## è¯·æ±‚å’Œå“åº”å¤„ç†

--

- åºåˆ—åŒ– / ååºåˆ—åŒ–ï¼ˆSerialization / Deserializationï¼‰

.footnote[
https://en.wikipedia.org/wiki/Serialization
]

---

## è¯·æ±‚å’Œå“åº”å¤„ç†

- åºåˆ—åŒ– / ååºåˆ—åŒ–ï¼ˆSerialization / Deserializationï¼‰

<img src="./images/timetravel0.png" width="700px">


.footnote[
https://en.wikipedia.org/wiki/Serialization
]

---

## è¯·æ±‚å’Œå“åº”å¤„ç†

- åºåˆ—åŒ– / ååºåˆ—åŒ–ï¼ˆSerialization / Deserializationï¼‰

<img src="./images/timetravel1.png" width="700px">


.footnote[
https://en.wikipedia.org/wiki/Serialization
]

---

## è¯·æ±‚å’Œå“åº”å¤„ç†

- åºåˆ—åŒ– / ååºåˆ—åŒ–ï¼ˆSerialization / Deserializationï¼‰

<img src="./images/timetravel2.png" width="700px">

.footnote[
https://en.wikipedia.org/wiki/Serialization
]

---

## è¯·æ±‚å’Œå“åº”å¤„ç†

- åºåˆ—åŒ– / ååºåˆ—åŒ–ï¼ˆSerialization / Deserializationï¼‰

.footnote[
- https://en.wikipedia.org/wiki/Marshalling_(computer_science)
- https://en.wikipedia.org/wiki/Unmarshalling
]

--

- å°è£… / è§£å°è£…ï¼ˆMarshalling / Unmarshallingï¼‰
    - = è¯·æ±‚è§£æ / å“åº”æ ¼å¼åŒ–ï¼ˆParsing / Formattingï¼‰

--
    - â‰ˆ è¯·æ±‚å¤„ç† / å“åº”å¤„ç†


---
## è¯·æ±‚å’Œå“åº”å¤„ç†

- è¯·æ±‚å¤„ç† JSON -> Dict -validating-> Object -> Database 
    - è·å–è¯·æ±‚ä¸­çš„ JSON æ•°æ®
    - è§£ææˆ Python å­—å…¸
    - éªŒè¯å­—å…¸ä¸­çš„æ•°æ®ï¼ˆValidatingï¼‰
    - æŠŠå­—å…¸è½¬æ¢æˆæ¨¡å‹ç±»å®ä¾‹
- å“åº”å¤„ç† Database -(validating)-> Dict -> JSON
    - æŒ‰ç…§æŸç§æ¨¡å¼ï¼ˆSchemaï¼‰æŠŠæ¨¡å‹ç±»å®ä¾‹è½¬æ¢æˆå­—å…¸
    - æŠŠå­—å…¸è½¬æ¢æˆ JSON æ•°æ®

---
class: middle, center

# è¯·è¡¥å……å’Œçº æ­£ ğŸ™‹â€â™€ï¸ ğŸ™‹â€â™‚ï¸

---

class: center, middle, inverse

# ä»€ä¹ˆæ ·çš„ Web API æ‰æ˜¯çœŸæ­£çš„ REST APIï¼Ÿ

---

## REST æ¶æ„çš„çº¦æŸæ¡ä»¶

- å®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼ˆClient-Serverï¼‰
- æ— çŠ¶æ€ï¼ˆStatelessï¼‰
- ç¼“å­˜ï¼ˆCacheabilityï¼‰
- åˆ†å±‚ç³»ç»Ÿï¼ˆLayered Systemï¼‰
- æŒ‰éœ€ä»£ç ï¼ˆCode-On-Demandï¼Œå¯é€‰ï¼‰
- ç»Ÿä¸€æ¥å£ï¼ˆUniform Interfaceï¼‰
  - è¯·æ±‚ä¸­åŒ…å«èµ„æºçš„ IDï¼ˆResource identification in requestsï¼‰
  - èµ„æºé€šè¿‡æ ‡è¯†æ¥æ“ä½œï¼ˆResource manipulation through representationsï¼‰
  - æ¶ˆæ¯çš„è‡ªæˆ‘æè¿°æ€§ï¼ˆSelf-descriptive messagesï¼‰
  - ç”¨è¶…åª’ä½“é©±åŠ¨åº”ç”¨çŠ¶æ€ï¼ˆHypermedia as the engine of application stateï¼ŒHATEOASï¼‰

.footnote[

https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm

]

---

class: center, middle

# åŸºæœ¬æ²¡æœ‰å®Œå…¨ç¬¦åˆ REST è¦æ±‚çš„ Web API

---

## Richardson Maturity Model

REST æˆç†Ÿåº¦æ¨¡å‹

- Level 0ï¼šä½¿ç”¨ **HTTP**
- Level 1ï¼šå¼•å…¥**èµ„æº**çš„æ¦‚å¿µ
- Level 2ï¼šå¼•å…¥ **HTTP åŠ¨è¯**çš„æ¦‚å¿µ
- Level 3ï¼šå¼•å…¥äº†**è¶…åª’ä½“**çš„æ¦‚å¿µ

.footnote[
https://martinfowler.com/articles/richardsonMaturityModel.html
]

---

class: center, middle


![It's enough!](./images/enough.png)

---

class: center, middle

# ä¸ä¸€å®šè¦å®Œå…¨éµå®ˆè¿™äº›çº¦æŸ

---

## ä½¿ç”¨åè¯è¡¨ç¤ºèµ„æº

--

```bash
/token
  post
  delete
```

--

vs

```bash
/login
  post

/logout
  post
```

--

whatever.

--

ï¼ˆæ­£åœ¨é¢è¯•é™¤å¤–ï¼‰ ğŸ™„

--

```bash
/search
```

---

## ä½¿ç”¨é¦–éƒ¨å­—æ®µæè¿° API ç‰ˆæœ¬

--

```http
Accept: application/vnd.example.v1+json
```

or

```http
Accept-version: v1
```

--

vs

```bash
https://api.example.com/v1/
https://api-v1.example.com/
```

--

simple win.

--

but don't do this:

```bash
https://api.example.com/
https://new-api.example.com/
https://latest-api.example.com/
```

---

class: center, middle


# 60% RESTful is ok  ğŸ¤— 

---

class: middle

## ğŸ”˜ ç¬¦åˆæ ‡å‡†
## ğŸ”˜ ç¬¦åˆéœ€æ±‚ï¼Œæ˜“äºå®ç°å’Œç†è§£

---

class: middle

## ğŸ”˜  ç¬¦åˆæ ‡å‡†
## âœ… ç¬¦åˆéœ€æ±‚ï¼Œæ˜“äºå®ç°å’Œç†è§£


---

class: center, middle, inverse

# æœ‰å“ªäº›è¾…åŠ©å¼€å‘ Web API çš„ Flask æ‰©å±•ï¼Ÿ

---

## Flask Web API æ‰©å±•

- Flask-RESTful (key part deprecated)
- Flask-RESTPlus (same with Flask-RESTful)
- Flask-API (author left)
- Flask-Restless (abandoned)
- Flask-REST-JSONAPI
- Flask-Potion
- Flask-apispec ğŸˆ


.footnote[
- https://github.com/flask-restful/flask-restful
- https://github.com/noirbizarre/flask-restplus
- https://github.com/flask-api/flask-api
- https://github.com/jfinkels/flask-restless
- https://github.com/miLibris/flask-rest-jsonapi
- https://github.com/biosustain/potion
- https://github.com/jmcarp/flask-apispec
]

---

class: middle

### ğŸ”˜ Django
### âœ… Flask


---

class: middle


### ğŸ”˜ æ–¹ä¾¿
### âœ… çµæ´» + å¯æ§åˆ¶


---

class: middle

### ğŸ”˜ Pipenv
### âœ… pip + virtualenv/venv + pip-tools + ...

---

class: middle

### ğŸ”˜ Flask + ä¸€ä¸ªå¤§è€Œå…¨çš„ Web API æ‰©å±•\*
### âœ… Flask + ä¸€ç»„ä¼˜ç§€çš„ Web API å·¥å…·ç»„åˆ

.footnote[
æ³¨ï¼šåœ¨æ²¡æœ‰ä¸€ä¸ªåƒ DRF é‚£æ ·å®Œç¾çš„å¤§è€Œå…¨æ‰©å±•é€‰é¡¹çš„å‰æä¸‹â€¦â€¦
]

---

class: middle, center

# So...

---
class: center, middle, inverse

# è¯•è¯•ä½¿ç”¨ Flask åŸç”Ÿå®ç° Web API å§ï¼

---

## ç”Ÿæˆ JSON æ•°æ®å’Œå“åº”

app
```python
from flask import Flask, jsonify
app = Flask(__name__)
```

data
```python
data = {
    'en': 'Hello',
    'zh': 'ä½ å¥½',
    'jp': 'kong ni ji wa'
}
```

return `jsonify` call
```python
@app.route('/')
def hello():
*   return jsonify(data)
```

---

## ç”Ÿæˆ JSON æ•°æ®å’Œå“åº”

app
```python
from flask import Flask
app = Flask(__name__)
```

data
```python
data = {
    'en': 'Hello',
    'zh': 'ä½ å¥½',
    'jp': 'kong ni ji wa'
}
```

return dict (new in 1.1)
```python
@app.route('/')
def hello():
*   return data  
```

---

## èµ„æºç«¯ç‚¹ï¼ˆview functionï¼‰

```python
@app.route('/notes/<int:note_id>', methods=['GET'])
def get_note(note_id):
    pass

@app.route('/notes/<int:note_id>', methods=['PUT'])
def update_note(note_id):
    pass

@app.route('/notes/<int:note_id>', methods=['DELETE'])
def delete_note(note_id):
    pass

@app.route('/notes', methods=['GET'])
def get_notes():
    pass

@app.route('/notes', methods=['POST'])
def new_note():
    pass
```

---

## èµ„æºç«¯ç‚¹ï¼ˆclass based viewï¼‰

```python
from flask.views import MethodView

class Note(MethodView):
    def get(self, note_id):
        pass

    def put(self, note_id):
        pass

    def delete(self, note_id):
        pass

class Notes(MethodView):
    def get(self):
        pass

    def post(self):
        pass

app.add_url_rule('/notes/<int:note_id>', view_func=Note.as_view('note'), 
    methods=['GET', 'PUT', 'DELETE'])
app.add_url_rule('/notes', view_func=Notes.as_view('notes'), 
    methods=['GET', 'POST'])
```

---

## ç®¡ç† API ç‰ˆæœ¬

```python
from apis.v1 import api_v1
from apis.v2 import api_v2

def create_app()
    app = Flask(__name__)
    app.register_blueprint(api_v1, url_prefix='api/v1/')
    app.register_blueprint(api_v2, url_prefix='api/v2/')
    return app
```

---

## é”™è¯¯å¤„ç†

```python
from flask import jsonify
from werkzeug.exceptions import default_exceptions

def api_abort(code, message=None, **kwargs):
    if message is None and code in default_exceptions:
        message = default_exceptions[code].description

    response = jsonify(code=code, message=message, **kwargs)
    response.status_code = code
    return response
```

- ç”¨äºä¸»åŠ¨è¿”å›é”™è¯¯å“åº”
- ä» Werkzeug è·å– HTTP é”™è¯¯çš„åŸå› çŸ­è¯­ä½œä¸ºé”™è¯¯æè¿°
- å¯ä»¥è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯å’Œé™„åŠ å…¶ä»–æ•°æ®

---

## é”™è¯¯å¤„ç†

```python
from flask import jsonify
from werkzeug.exceptions import default_exceptions

def api_abort(code, message=None, **kwargs):
    if message is None and code in default_exceptions:
*       message = default_exceptions[code].description

    response = jsonify(code=code, message=message, **kwargs)
    response.status_code = code
    return response
```

- ç”¨äºä¸»åŠ¨è¿”å›é”™è¯¯å“åº”
- ä» Werkzeug è·å– HTTP é”™è¯¯çš„åŸå› çŸ­è¯­ä½œä¸ºé”™è¯¯æè¿°
- å¯ä»¥è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯å’Œé™„åŠ å…¶ä»–æ•°æ®

---

## é”™è¯¯å¤„ç†

usage 1

```python
return api_abort(403)
```

usage 2

```python
return api_abort(code=400, message='Wrong password!')
```

usage 3
```python
@app.errorhandler(404)
def page_not_found(e):
    return api_abort(404)

@app.errorhandler(405)
def method_not_allowed(e):
    return api_abort(405)

@app.errorhandler(500)
def internal_server_error(e):
    return api_abort(500)
```

---

## æ•°æ®æ¨¡å¼

```python
def note_schema(note):
    return {
        'id': note.id,
        'self': url_for('.note', note_id=note.id, _external=True),
        'kind': 'Note',
        'body': note.body,
        'author': {
            'id': 1,
            'url': url_for('.user', _external=True),
            'username': note.author.username,
            'kind': 'User',
        },
    }
```

--

```python
class Note(MethodView):

    def get(self, note_id):
        note = NoteModel.query.get_or_404(note_id)
*       return note_schema(note)
```

---

## æ•°æ®æ¨¡å¼ï¼ˆåˆ†é¡µï¼‰

```python
def notes_schema(notes, current, prev, next, pagination):
    return {
        'self': current,
        'kind': 'NoteCollection',
*       'notes': [note_schema(note) for note in notes],
        'prev': prev,
        'last': url_for('.notes', page=pagination.pages, _external=True),
        'first': url_for('.notes', page=1, _external=True),
        'next': next,
        'count': pagination.total
    }
```

---

## æ•°æ®æ¨¡å¼ï¼ˆåˆ†é¡µï¼‰


```python
class Notes(MethodView):
    def get(self):
        page = request.args.get('page', 1, type=int)
        per_page = request.args.get('per_page', 10, type=int)
        per_page_max = current_app.config['NOTE_PER_PAGE_MAX']
        if per_page > per_page_max:
            per_page = current_app.config['NOTE_PER_PAGE']
        
        pagination = NoteModel.query.paginate(page, per_page)
        notes = pagination.items
        
        current = url_for('.notes', page=page, _external=True)
        prev = None
        if pagination.has_prev:
            prev = url_for('.notes', page=page - 1, _external=True)
        next = None
        if pagination.has_next:
            next = url_for('.notes', page=page + 1, _external=True)
*       return notes_schema(notes, current, prev, next, pagination)
```

---

## è¯·æ±‚è§£æ

validate
```python
def validate_note(json):
    body = json.get('body')
    if body is None or str(body).strip() == '':
        raise ValidationError('The note body was empty or invalid.')
    return Note(body=body, author=g.current_user)
```

--

exception
```python
class ValidationError(ValueError):
    pass
```

--

error handler
```python
@app.errorhandler(ValidationError)
def validation_error(e):
    return api_abort(400, e.args[0])
```

---

## è¯·æ±‚è§£æ

```python
class Notes(MethodView):

    @auth_required
    def post(self):
        """Create new note."""
*       note = validate_note(request.get_json())
        db.session.add(note)
        db.session.commit()
        response = jsonify(note_schema(note))
        response.status_code = 201
        response.headers['Location'] = url_for('.note', note_id=note.id, 
            _external=True)
        return response
```

---

## OAuth 2.0 Flow

- é¢å‘ç¬¬ä¸‰æ–¹å¤§è§„æ¨¡å…¬å¼€
    - Authorization Codeï¼ˆæˆæƒç æ¨¡å¼ï¼‰

- é¢å‘å…¬å¸å†…éƒ¨å…¬å¼€
    - Resource Owner Password Credentialsï¼ˆå¯†ç æ¨¡å¼ï¼‰


.footnote[
https://auth0.com/docs/api-auth/which-oauth-flow-to-use#oauth-2-0-terminology
]

---

## èº«ä»½è®¤è¯

```python
class AuthToken(MethodView):

    def post(self):
        grant_type = request.form.get('grant_type')
        username = request.form.get('username')
        password = request.form.get('password')

        # validate grant_type, username and password

        token, expiration = generate_token(user)

        response = jsonify({
            'access_token': token,
            'token_type': 'Bearer',
            'expires_in': expiration
        })
        response.headers['Cache-Control'] = 'no-store'
        response.headers['Pragma'] = 'no-cache'
        return response

app.add_url_rule('/oauth/token', view_func=AuthToken.as_view('token'), 
    methods=['POST'])
```

---

## èº«ä»½è®¤è¯

```python
from flask import g, current_app, request
from itsdangerous import TimedJSONWebSignatureSerializer as Serializer,\
    BadSignature, SignatureExpired


def generate_token(user):
    expiration = 3600
    s = Serializer(current_app.config['SECRET_KEY'], 
        expires_in=expiration)
    token = s.dumps({'id': user.id}).decode('ascii')
    return token, expiration

def validate_token(token):
    s = Serializer(current_app.config['SECRET_KEY'])
    try:
        data = s.loads(token)
    except (BadSignature, SignatureExpired):
        return False
    user = User.query.get(data['id'])
    if user is None:
        return False
    g.current_user = user
    return True
```

---

## èº«ä»½è®¤è¯

```python
from functools import wraps

def auth_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        token_type, token = get_token()

        if request.method != 'OPTIONS':
            if token_type is None or token_type.lower() != 'bearer':
                return api_abort(400, 'The token type must be bearer.')
            if token is None:
                return token_missing()
            if not validate_token(token):
                return invalid_token()
        return f(*args, **kwargs)

    return decorated
```

---

## èº«ä»½è®¤è¯

```python
def get_token():
    if 'Authorization' in request.headers:
        try:
            token_type, token = request.headers['Authorization'].\
            split(None, 1)
        except ValueError:
            token_type = token = None
    else:
        token_type = token = None

    return token_type, token
```

---

## èº«ä»½è®¤è¯

```python
def invalid_token():
    response = api_abort(401, error='invalid_token', 
        error_description='Either the token was expired or invalid.')
    response.headers['WWW-Authenticate'] = 'Bearer'
    return response

def token_missing():
    response = api_abort(401)
    response.headers['WWW-Authenticate'] = 'Bearer'
    return response
```

---
## æ¨èçš„å­¦ä¹ è·¯å¾„

0. äº†è§£ Web API çš„è®¾è®¡åŸåˆ™
1. å­¦ä¹  Flask åŸç”Ÿå®ç°
2. å­¦ä¹ æ­é…å…¶ä»–å·¥å…·
    - è¯·æ±‚è§£æ Webargs
    - å“åº”æ ¼å¼åŒ– Marshmallow
    - æ–‡æ¡£ APISpec
    - ç”¨æˆ·è®¤è¯ Flask-HTTPAuthã€Flask-OAuthlibã€Authlib

.footnote[
- https://github.com/marshmallow-code/webargs
- https://github.com/marshmallow-code/marshmallow
- https://github.com/marshmallow-code/apispec
- https://github.com/miguelgrinberg/flask-httpauth
- https://github.com/lepture/flask-oauthlib
- https://github.com/lepture/authlib

]

---

## å…¶ä»– Web API æ¡†æ¶

- Django REST Framework (Django)
- Hug
- APIStar
- Starlette
- FastAPI
- Falcon
- Connexion (Flask)
- Eve (Flask)
- â€¦â€¦

.footnote[
- https://github.com/encode/django-rest-framework
- https://github.com/hugapi/hug
- https://github.com/encode/apistar
- https://github.com/encode/starlette
- https://github.com/tiangolo/fastapi
- https://github.com/falconry/falcon
- https://github.com/zalando/connexion
- https://github.com/pyeve/eve
]

---

## NoteAPI

- Web API ç¤ºä¾‹ç¨‹åºé›†åˆ
- å¸®åŠ©ä½ é€‰æ‹©é€‚åˆçš„æ¡†æ¶/æ‰©å±•
- ä½¿ç”¨ä¸åŒçš„ REST/API æ¡†æ¶ã€Flask æ‰©å±•ã€å·¥å…·å®ç°åŒä¸€ä¸ª Web API
.footnote[
https://github.com/greyli/noteapi
]

--

- ï¼ˆç›®å‰åªæ˜¯ä¸€ä¸ª README é¡¹ç›® ğŸ˜ï¼‰

---

class: center, middle, inverse

# Q&A

---

## è°¢è°¢

<img src="./images/wechat.png" width="200px">

- email: withlihui@gmail.com
- website: [greyli.com](http://greyli.com)
- code: [github.com/greyli/noteapi](https://github.com/greyli/noteapi)
- slides: [github.com/greyli/pyconchina2019-api](https://github.com/greyli/pyconchina2019-api)

    </textarea>
    <script src="js/remark.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '4:3',
        highlightStyle: 'github',
        highlightLines: true,
        slideNumberFormat: '',
      });
    </script>
  </body>
</html>
