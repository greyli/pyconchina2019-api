<!DOCTYPE html>
<html>
  <head>
    <title>åŸºäº Flask çš„ Web API å¼€å‘æŒ‡å— - PyCon China 2019</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="./css/style.css">

    <script>

        var nan = function() {
            document.getElementById("blink").innerHTML="å—";
        } 
        var bei = function() {
            document.getElementById("blink").innerHTML="åŒ—";
            setTimeout(nan, 150)
        }   
        setInterval(bei, 2000);
    </script>
  </head>
  <body>

    <textarea id="source">

class: center, middle, title

<h1>åŸºäº Flask çš„ Web API å¼€å‘æŒ‡<span id="blink">å—</span></h1>

æè¾‰ï¼ˆGrey Liï¼‰ ğŸ PyCon China 2019 ä¸Šæµ·

---

class: center, middle, inverse


## è¿™æœ¬æ¥æ˜¯ä¸€ä¸ªä¸¥è‚ƒçš„æ¼”è®²

---

## Flask æ˜¯ä»€ä¹ˆï¼Ÿ

install
```bash
$ pip install flask
```

code (app.py)
```python
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return 'Hello, PyCon China!'
```

run
```bash
$ flask run
 ...
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
```

---

## Web API æ˜¯ä»€ä¹ˆï¼Ÿ

--

- é•¿ç­”æ¡ˆï¼šhttps://lmgtfy.com/?q=what+is+web+api%3F

--

- çŸ­ç­”æ¡ˆï¼šå¯ä»¥ä½¿ç”¨ HTTP åè®®è¿›è¡Œè®¿é—®ï¼Œè¿”å› XML æˆ– JSON æ ¼å¼æ•°æ®çš„ API

--

- å†çŸ­ä¸€ç‚¹ï¼šJSON over HTTP æˆ– XML over HTTP

--

- ç‰¹ç‚¹ï¼š
    - ä½¿ç”¨ HTTP è®¿é—®
    - è¿”å› JSON æˆ– XML æ ¼å¼çš„çº¯æ•°æ®
    - ä½¿ç”¨ URL æè¿°èµ„æº
    - ä½¿ç”¨ä¸åŒçš„ HTTP æ–¹æ³•è¡¨ç¤ºä¸åŒçš„æ“ä½œ

---

## æœ€ç®€å•çš„ Web API

code (app.py)
```python
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello_api():
    return {'message': 'Hello, PyCon China!'} 
```

---

## æœ€ç®€å•çš„ Web API

code (app.py)
```python
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello_api():
*   return {'message': 'Hello, PyCon China!'} 
```

--

test (with `pip install httpie`)
```bash
$ http http://localhost:5000
HTTP/1.0 200 OK
Content-Length: 30
Content-Type: application/json
Date: Tue, 17 Sep 2019 01:10:24 GMT
Server: Werkzeug/0.15.6 Python/3.6.8

{
    "message": "Hello, PyCon China!"
}
```

---

## æè¾‰ / Grey Li

<img src="./images/four.jpg" width="200px">

- ç‹¬ç«‹ Web å¼€å‘è€…
- Flask ç»´æŠ¤è€…ä¹‹ä¸€
- ã€ŠFlask Web å¼€å‘å®æˆ˜ã€‹ä½œè€…
- [HelloFlask](http://helloflaks.com) ç®¡ç†å‘˜
- ä¸ªäººç½‘ç«™ [greyli.com](http://greyli.com)

---

class: center, middle, inverse

# ä¸€ä¸ªåˆæ ¼çš„ Python ç¨‹åºå‘˜åº”è¯¥äº†è§£çš„äº‹æƒ…

---
class: center, middle


# ğŸ‘€ æ­£ç¡®è¯†è®¤ Logoï¼Œä»æˆ‘åšèµ·

---
class: center, middle


<img src="./images/flask.png" width="400px">

---
class: center, middle

<img src="./images/real-flask.png" width="800px">

---
class: center, middle


# é‡è¦çš„äº‹æƒ…è®²ä¸‰é

---
class: center, middle

#  ğŸ‘…  æŒæ¡æ­£ç¡®çš„è‹±è¯­å‘éŸ³ï¼Œä»æˆ‘åšèµ·

---

class: center, middle

# Werkzeug

---
class: center, middle

# / (ËˆvÉ›ÉÌ¯kËŒtsÉ”ÊÌ¯k) / (than ke sao yi ke)

<br>

<audio src="./audios/werkzeug.mp3" controls=""></audio>

ï¼ˆå‘éŸ³æ¥è‡ªä½œè€…æœ¬äººï¼‰

---

class: center, middle

# Jinja

---

class: center, middle

# / (ËˆdÊ’ÉªndÊ’É™) / (jin ja)

<br>

<audio src="./audios/jinja.mp3" controls=""></audio>

---
class: center, middle

# Django

---

class: center, middle


# ä½å‹ç‹—ã€ä½ç®€ç‹—ã€åœ°å¼ ç‹—ã€åœ°å ç‹—ã€æ±Ÿç‹—ï¼Ÿ

---
class: center, middle

# [JANG-oh](https://docs.djangoproject.com/en/dev/faq/general/#what-does-django-mean-and-how-do-you-pronounce-it) (zhan go)

<br>

<audio src="./audios/django.mp3" controls=""></audio>

---

class: center, middle


# ğŸ§  ä½¿ç”¨æ­£ç¡®çš„æœ¯è¯­ï¼Œä»æˆ‘åšèµ·

---

class: center, middle


# API / API æ¥å£ï¼Ÿ

---

class: center, middle

# å¾®æœåŠ¡ï¼Ÿ

---

class: center, middle


# REST API / RESTful APIï¼Ÿ

---

class: center, middle


# Web æœåŠ¡ï¼Ÿ

---

class: center, middle

# Web API âœ”ï¸ 

---
class: center, middle, inverse

# ä»€ä¹ˆæ ·çš„ Web API æ‰æ˜¯çœŸæ­£çš„ REST APIï¼Ÿ

---

## REST æ¶æ„çš„çº¦æŸæ¡ä»¶

- å®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼ˆClient-Serverï¼‰
- æ— çŠ¶æ€ï¼ˆStatelessï¼‰
- ç¼“å­˜ï¼ˆCacheabilityï¼‰
- åˆ†å±‚ç³»ç»Ÿï¼ˆLayered Systemï¼‰
- æŒ‰éœ€ä»£ç ï¼ˆCode-On-Demandï¼Œå¯é€‰ï¼‰
- ç»Ÿä¸€æ¥å£ï¼ˆUniform Interfaceï¼‰
  - è¯·æ±‚ä¸­åŒ…å«èµ„æºçš„ IDï¼ˆResource identification in requestsï¼‰
  - èµ„æºé€šè¿‡æ ‡è¯†æ¥æ“ä½œï¼ˆResource manipulation through representationsï¼‰
  - æ¶ˆæ¯çš„è‡ªæˆ‘æè¿°æ€§ï¼ˆSelf-descriptive messagesï¼‰
  - ç”¨è¶…åª’ä½“é©±åŠ¨åº”ç”¨çŠ¶æ€ï¼ˆHypermedia as the engine of application stateï¼ŒHATEOASï¼‰

---

class: center, middle

# åŸºæœ¬æ²¡æœ‰å®Œå…¨ç¬¦åˆ REST è¦æ±‚çš„ API

---

class: center, middle

# ä¸ä¸€å®šè¦å®Œå…¨éµå®ˆè¿™äº›çº¦æŸ

---

class: center, middle


![It's enough!](./images/enough.png)

---

## ä½¿ç”¨åè¯è¡¨ç¤ºèµ„æº

--

```bash
/token
    post
    delete
```

--

vs

```bash
/login
    post

/logout
    post
```

--

whatever.

--

ï¼ˆæ­£åœ¨é¢è¯•é™¤å¤–ï¼‰ ğŸ™„

--

```bash
/search
```

---

## ä½¿ç”¨é¦–éƒ¨æè¿° API ç‰ˆæœ¬

--

```http
Accept: application/vnd.example.v1+json
```

or

```http
Accept-version: v1
```

--

vs

```bash
https://api.example.com/v1/
https://api-v1.example.com/
```

--

it depends.

--

but don't do this:
```bash
https://api.example.com/
https://new-api.example.com/
https://latest-api.example.com/
```

---

class: center, middle


# 60% RESTful is ok ğŸ¤”

---

class: center, middle

# ç¬¦åˆéœ€æ±‚ã€æ˜“äºå®ç°ã€æ˜“äºç†è§£ > ç¬¦åˆæ ‡å‡†

---

class: center, middle, inverse


# ä¸ä¸€å®šéè¦ä½¿ç”¨æ‰©å±•æ¥å®ç° Web API

---

class: center, middle


# æœ‰ä¸€äº› Flask æ‰©å±•å¾ˆå‘â€¦â€¦

---

## ä½ ä»¥ä¸ºçš„å‘

<img src="./images/small-hole.jpg" width="600px">

---

## å®é™…çš„å‘

<img src="./images/big-hole2.jpg" width="700px">

---

## ç”šè‡³æ˜¯è¿™æ ·çš„å‘

<img src="./images/black-hole.jpg" width="600px">

---

## Flask Web API æ‰©å±•

- Flask-RESTful
- Flask-RESTPlus
- Flask-Restless
- Flask-API
- â€¦â€¦

---

class: center, middle

# é¿å…å¼•å…¥ä¸å¿…è¦çš„å¤æ‚åº¦

---
class: center, middle, inverse

# è¯•è¯•ä½¿ç”¨ Flask åŸç”Ÿå®ç° Web API å§

---

## è¿”å› jsonify() å’Œå­—å…¸éƒ½å¯ä»¥

app
```python
flask flask import Flask # jsonify
app = Flask(__name__)
```

data
```python
data = {
    'en': 'Hello',
    'zh': 'ä½ å¥½',
    'jp': 'kong ni ji wa'
}
```

return dict (new in 1.1)
```python
@app.route('/')
def hello_api():
    return data  
    # return jsonify(data)
```

---

## ä½¿ç”¨å‡½æ•°å’Œç±»éƒ½å¯ä»¥

view function
```python
@app.route('/note/<int:id>', methods=['GET'])
def get_note(id):
    pass

@app.route('/note/<int:id>', methods=['DELETE'])
def delete_note(id):
    pass
```


class view
```python
from flask.views import MethodView

class Note(MethodView):

    def get(self, note_id):
        pass

    def delete(self, note_id):
        pass

app.add_url_rule('/notes/<int:note_id>', view_func=Note.as_view('note'), methods=['GET', 'DELETE'])
```

---

## ä½¿ç”¨è“æœ¬æ¥ç»„ç»‡ API ç‰ˆæœ¬

```
apis/ # app package
  - v1
    - note.py
    - user.py
  - v2
    - note.py
    - user.py
  - __init__.py
  - models.py
  - decorators.py
  - auth.py
  - errors.py
```

--

```python
from apis.v1 import api_v1
from apis.v2 import api_v2

def create_app()
    app = Flask(__name__)
    app.register_blueprint(api_v1, url_prefix='api/v1/')
    app.register_blueprint(api_v2, url_prefix='api/v2/')
    return app
```

---

## é”™è¯¯å¤„ç†

```python
from flask import jsonify
from werkzeug.http import HTTP_STATUS_CODES

def api_abort(code, message=None, **kwargs):
    if message is None:
        message = HTTP_STATUS_CODES.get(code, 'Error')

    response = jsonify(code=code, message=message, **kwargs)
    response.status_code = code
    return response  # You can also just return (response, code) tuple
```

- ç”¨äºä¸»åŠ¨è¿”å›é”™è¯¯å“åº”
- ä» Werkzeug è·å– HTTP é”™è¯¯çš„çŠ¶æ€ç ä½œä¸ºé”™è¯¯æè¿°
- å¯ä»¥è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯å’Œé™„åŠ å…¶ä»–æ•°æ®

---

## é”™è¯¯å¤„ç†

```python
from flask import jsonify
from werkzeug.http import HTTP_STATUS_CODES

def api_abort(code, message=None, **kwargs):
    if message is None:
*       message = HTTP_STATUS_CODES.get(code, 'Error')

    response = jsonify(code=code, message=message, **kwargs)
    response.status_code = code
    return response  # You can also just return (response, code) tuple
```

- ç”¨äºä¸»åŠ¨è¿”å›é”™è¯¯å“åº”
- ä» Werkzeug è·å– HTTP é”™è¯¯çš„çŠ¶æ€ç ä½œä¸ºé”™è¯¯æè¿°
- å¯ä»¥è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯å’Œé™„åŠ å…¶ä»–æ•°æ®

---

## é”™è¯¯å¤„ç†

usage 1

```python
if g.current_user != item.author:
    return api_abort(403)
```

usage 2

```python
if user is None or not user.validate_password(password):
    return api_abort(code=400, message='Either the username or password was invalid.')
```

---

## é”™è¯¯å¤„ç†

usage 3

```python
@app.errorhandler(404)
def page_not_found(e):
    return api_abort(404)

@app.errorhandler(405)
def method_not_allowed(e):
    return api_abort(405)

@app.errorhandler(500)
def internal_server_error(e):
    return api_abort(500)
```

---

## JSON æ•°æ®å°è£…

```python
def note_schema(note):
    return {
        'id': note.id,
        'self': url_for('.note', note_id=note.id, _external=True),
        'kind': 'Note',
        'body': note.body,
        'author': {
            'id': 1,
            'url': url_for('.user', _external=True),
            'username': note.author.username,
            'kind': 'User',
        },
    }
```

- æŠŠæ¨¡å‹ç±»æ•°æ®åºåˆ—åŒ–ï¼ˆserializeï¼‰æˆ JSON æ•°æ®
- ä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªå‡½æ•°ä½œä¸ºæ–¹æ³•æ”¾åˆ°æ¨¡å‹ç±»é‡Œ
- ä½¿ç”¨ url_for() ç”Ÿæˆ URL

---

## JSON æ•°æ®å°è£…

```python
class NoteAPI(MethodView):
    decorators = [auth_required]

    def get(self, note_id):
        """Get note."""
        note = Note.query.get_or_404(note_id)
        if g.current_user != item.author:
            return api_abort(403)
*       return note_schema(note)
```

---

## åˆ†é¡µ

```python
def notes_schema(notes, current, prev, next, pagination):
    return {
        'self': current,
        'kind': 'NoteCollection',
        'notes': [note_schema(note) for note in notes],
        'prev': prev,
        'last': url_for('.notes', page=pagination.pages, _external=True),
        'first': url_for('.notes', page=1, _external=True),
        'next': next,
        'count': pagination.total
    }
```

---

## åˆ†é¡µ

```python
class NotesAPI(MethodView):
    decorators = [auth_required]

    def get(self):
        """Get current user's all items."""
        page = request.args.get('page', 1, type=int)
        per_page = request.args.get('per_page', 10, type=int)
        if per_page > 10:
            per_page = current_app.config['NOTE_PER_PAGE']
        pagination = Note.query.with_parent(g.current_user).paginate(page, per_page)
        notes = pagination.items
        current = url_for('.notes', page=page, _external=True)
        prev = None
        if pagination.has_prev:
            prev = url_for('.notes', page=page - 1, _external=True)
        next = None
        if pagination.has_next:
            next = url_for('.notes', page=page + 1, _external=True)
*       return notes_schema(notes, current, prev, next, pagination)
```

---

## è¯·æ±‚è§£æ

validate
```python
def validate_note(json):
    body = json.get('body')
    if body is None or str(body).strip() == '':
        raise ValidationError('The note body was empty or invalid.')
    return Note(body=body, author=g.current_user)
```

error
```python
class ValidationError(ValueError):
    pass

@app.errorhandler(ValidationError)
def validation_error(e):
    return api_abort(400, e.args[0])
```

---

## è¯·æ±‚è§£æ

```python
class NotesAPI(MethodView):
    decorators = [auth_required]

    def post(self):
        """Create new note."""
*       note = validate_note(request.get_json())
        db.session.add(note)
        db.session.commit()
        response = jsonify(note_schema(note))
        response.status_code = 201
        response.headers['Location'] = url_for('.note', note_id=note.id, _external=True)
        return response
```

---

## èº«ä»½è®¤è¯

```python
class AuthTokenAPI(MethodView):

    def post(self):
        grant_type = request.form.get('grant_type')
        username = request.form.get('username')
        password = request.form.get('password')

        # validate grant_type, username and password

        token, expiration = generate_token(user)

        response = jsonify({
            'access_token': token,
            'token_type': 'Bearer',
            'expires_in': expiration
        })
        response.headers['Cache-Control'] = 'no-store'
        response.headers['Pragma'] = 'no-cache'
        return response

    api_v1.add_url_rule('/oauth/token', view_func=AuthTokenAPI.as_view('token'), methods=['POST'])
```

---

## èº«ä»½è®¤è¯

```python
from flask import g, current_app, request
from itsdangerous import TimedJSONWebSignatureSerializer as Serializer, BadSignature, SignatureExpired


def generate_token(user):
    expiration = 3600
    s = Serializer(current_app.config['SECRET_KEY'], expires_in=expiration)
    token = s.dumps({'id': user.id}).decode('ascii')
    return token, expiration

def validate_token(token):
    s = Serializer(current_app.config['SECRET_KEY'])
    try:
        data = s.loads(token)
    except (BadSignature, SignatureExpired):
        return False
    user = User.query.get(data['id'])
    if user is None:
        return False
    g.current_user = user
    return True
```

---

## èº«ä»½è®¤è¯

```python
from functools import wraps

def auth_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        token_type, token = get_token()

        if request.method != 'OPTIONS':
            if token_type is None or token_type.lower() != 'bearer':
                return api_abort(400, 'The token type must be bearer.')
            if token is None:
                return token_missing()
            if not validate_token(token):
                return invalid_token()
        return f(*args, **kwargs)

    return decorated
```

---

## èº«ä»½è®¤è¯

```python
def get_token():
    if 'Authorization' in request.headers:
        try:
            token_type, token = request.headers['Authorization'].split(None, 1)
        except ValueError:
            token_type = token = None
    else:
        token_type = token = None

    return token_type, token
```

---

## èº«ä»½è®¤è¯

```python
def invalid_token():
    response = api_abort(401, error='invalid_token', error_description='Either the token was expired or invalid.')
    response.headers['WWW-Authenticate'] = 'Bearer'
    return response

def token_missing():
    response = api_abort(401)
    response.headers['WWW-Authenticate'] = 'Bearer'
    return response
```

---

## å…¶ä»–é€‰æ‹©

- Django REST Framework
- API Star
- Starlette
- Hug
- FastAPI
- Falcon
- Eve (based on Flask)
- Connexion (based on Flask)
- â€¦â€¦

---

class: center, middle, inverse

# è°¢è°¢

---

# æ’æ’­ä¸€æ¡å¹¿å‘Š

- æ—¶é—´ï¼šä¸‹åˆ 4:40

- åœ°ç‚¹ï¼šå°±åœ¨è¿™ä¸ªä¼šåœº

- äº‹ä»¶ï¼šé—ªç”µæ¼”è®²

- äººç‰©ï¼šç­‰ä½ 

---

## Links & Contact

<img src="./images/wechat.png" width="200px">

- website: [greyli.com](http://greyli.com)
- code: [github.com/greyli/noteapi](https://github.com/greyli/noteapi)
- slides: [github.com/greyli/pyconchina2019-api](https://github.com/greyli/pyconchina2019-api)

    </textarea>
    <script src="js/remark.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        highlightStyle: 'github',
        highlightLines: true,
      });
    </script>
  </body>
</html>